<!DOCTYPE html>
<html>
<head>
<meta charset=utf-8 />
<title>Map</title>
<meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src="//cdnjs.cloudflare.com/ajax/libs/angular.js/1.2.20/angular.js"></script>
    <script src="//ajax.googleapis.com/ajax/libs/angularjs/1.2.25/angular-route.js"></script>
    <script src="js/services/BestService.js"></script>
    <script src="js/controllers/BestCtrl.js"></script>
    <script src="js/services/UserService.js"></script>
    <script src="js/controllers/UserCtrl.js"></script>
    <script src="js/controllers/LayerCtrl.js"></script>
    <script src="js/appRoutes.js"></script>
    <script src="./routes.js"></script>
    <script src="js/app.js"></script>
<script src='https://api.tiles.mapbox.com/mapbox.js/v2.1.4/mapbox.js'></script>
<link href='https://api.tiles.mapbox.com/mapbox.js/v2.1.4/mapbox.css' rel='stylesheet' />
<link href="./style.css" rel="stylesheet" type="text/css">

</head>
<body>
  <div id="catToggle" class="overlay" ng-app="LayerCtrl" ng-controller="LayerController">
  <span>

    <select id="catSelector" ng-model="myLayers" ng-options="layer.name for layer in layers" >
      <option value=" <%= myLayers.name %>" ng-model="myLayers" ng-click="change(value);"> All</option>
    </select>
  </span>
  </div>
<div id='map'></div>

<!-- jQuery is required for this example. -->
<script src='https://code.jquery.com/jquery-1.11.0.min.js'></script>
<script>
L.mapbox.accessToken = 'pk.eyJ1IjoicHN3ZWV0cG90YXRvIiwiYSI6IjN1eWtxVnMifQ.EPs2g3oW5H1g92TAGy0hfg';
var map = L.mapbox.map('map', 'psweetpotato.j7cn54e5')
    .setView([40.751, -73.985], 13);

// Credit Foursquare for their wonderful data
map.attributionControl
    .addAttribution('<a href="https://foursquare.com/">Places data from Foursquare</a>');

// Create a Foursquare developer account: https://developer.foursquare.com/
// NOTE: CHANGE THESE VALUES TO YOUR OWN:
// Otherwise they can be cycled or deactivated with zero notice.
var CLIENT_ID = 'EDQQDZUP4CDNAVQTBA40QGR5FC5WPEASPLT5RX1B5XFOAGX5';
var CLIENT_SECRET = 'U4MOAXGON03440H1RK0ZG1NUF11DT3TY24FQXPARVGGBOS4T';
var searchWord = 'coffee';
// https://developer.foursquare.com/start/search
var API_ENDPOINT = 'https://api.foursquare.com/v2/venues/search' +
  '?client_id=CLIENT_ID' +
  '&client_secret=CLIENT_SECRET' +
  '&v=20130815' +
  '&ll=LATLON' +
  '&query='+ searchWord +
  '&callback=?';


//////encapsulate so each layer is toggled on and off via front end

// // loads all bests
// var allBests = L.layerGroup().addTo(map);
// $.get('/api/bests',  function(req, res) {
//   console.log(req);
//   for (var i = 0; i < req.length; i++) {
//     var venue = req[i].name;
//     var latlng = L.latLng(req[i].lat, req[i].lon);
//     var address = req[i].address;
//     var marker = L.marker(latlng, {
//           icon: L.mapbox.marker.icon({
//             'marker-color': '#F9AC6D',
//             'marker-symbol': 'restaurant',
//             'marker-size': 'medium'
//           })
//         })
//       .bindPopup(venue +'<br/>' + address)
//         .addTo(allBests);
//   }
// });

//loads bests of one category
$('#catSelector').change(function (newCat){
      console.log(newCat.currentTarget.value);
      var newCat = newCat.currentTarget.value;
      console.log(newCat);
var oneCategory = L.layerGroup().addTo(map);
$.get('/api/bests',  function(req, res) {
  console.log(req);
  for (var i = 0; i < req.length; i++) {
    console.log(req[i].category_id);
    console.log(newCat);
    if (req[i].category_id == newCat) {
      console.log(req[i].category);
      var venue = req[i].name;
      var latlng = L.latLng(req[i].lat, req[i].lon);
      var address = req[i].address;
      var marker = L.marker(latlng, {
          icon: L.mapbox.marker.icon({
            'marker-color': '#F9AC6D',
            'marker-symbol': 'restaurant',
            'marker-size': 'medium'
          })
        })
      .bindPopup(venue +'<br/>' + address)
        .addTo(oneCategory);
      }
  }
});
});





// // Use jQuery to make an AJAX request to Foursquare to load markers data.
// var foursquarePlaces = L.layerGroup().addTo(map);// Keep our place markers organized in a nice group.
// $.getJSON(API_ENDPOINT
//     .replace('CLIENT_ID', CLIENT_ID)
//     .replace('CLIENT_SECRET', CLIENT_SECRET)
//     .replace('LATLON', map.getCenter().lat +
//         ',' + map.getCenter().lng), function(result, status) {

//     if (status !== 'success') return alert('Request to Foursquare failed');

//     // Transform each venue result into a marker on the map.
//     for (var i = 0; i < result.response.venues.length; i++) {
//       var venue = result.response.venues[i];
//       var latlng = L.latLng(venue.location.lat, venue.location.lng);
//       var marker = L.marker(latlng, {
//           icon: L.mapbox.marker.icon({
//             'marker-color': '#BE9A6B',
//             'marker-symbol': 'cafe',
//             'marker-size': 'large'
//           })
//         })
//       .bindPopup('<strong><a href="https://foursquare.com/v/' + venue.id + '">' +
//         venue.name + '</a></strong>')
//         .addTo(foursquarePlaces);
//     }

// });
///user search with keyword to add bests
// var keyword = 'Van leeuwen';
// var searchAll = L.layerGroup().addTo(map);
// var API_ENDPOINT = 'https://api.foursquare.com/v2/venues/search' +
//   '?client_id=CLIENT_ID' +
//   '&client_secret=CLIENT_SECRET' +
//   '&v=20130815' +
//   '&ll=LATLON' +
//   '&query='+ keyword +
//   '&limit=7'
//   '&callback=?';

//   $.getJSON(API_ENDPOINT
//     .replace('CLIENT_ID', CLIENT_ID)
//     .replace('CLIENT_SECRET', CLIENT_SECRET)
//     .replace('LATLON', map.getCenter().lat +
//         ',' + map.getCenter().lng), function(result, status) {

//     if (status !== 'success') return alert('Request to Foursquare failed');
//     // make global so we can access it on click
//     venues = result.response.venues;
//     // Transform each venue result into a marker on the map.
//     for (var i = 0; i < result.response.venues.length; i++) {
//       var venue = result.response.venues[i];
//       console.log(venue)
//       var latlng = L.latLng(venue.location.lat, venue.location.lng);
//       var marker = L.marker(latlng, {
//           icon: L.mapbox.marker.icon({
//             'marker-color': '#F9AC6D',
//             'marker-symbol': 'restaurant',
//             'marker-size': 'medium'
//           })
//         })
//       .bindPopup(
//         '<strong><a href="https://foursquare.com/v/' + venue.id + '">' +
//         venue.name +
//         "</a></strong><br/><button class='addBest' data-venue_id='" + i + "' " + " class='" + venue.name + "'>Add Best</button>")
//         .addTo(searchAll);
//     }
// });
//   $("#map").on('click', '.addBest', function(){
//     // how do i get the venue information
//     // for the particular button clicked on
//     console.log('clicked!', this);
//     var number = $(this).data().venue_id;
//     console.log(venues[number]);
//     //FIXME add posting code
//     // var newBest = {name: venues[number].name,
//     //   lat: venues[number].location.lat,
//     //   lon: venues[number].location.lon,
//     //   address: venues[number].location.address,
//     //   category: 'category', //FIXME hardcoded
//     //   user: "544e939a59630d151c7b59d4"
//     // };
//     // app.post(newBest);
//   });
</script>
</body>
</html>
